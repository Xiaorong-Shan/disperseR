---
title: "Vignette - Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this vignette you will see how to use the `disperser` package. We will walk you through an example step by step. In this vignette we are using functions that will automatically download the needed data for you to run your analysis for the United States. We also provide other vignettes that show you how we processed the data used in case you want to run the analysis for a different country or using different data sources. 

## The step up 

We start by importing the packages that we will use in the analysis. Make sure you have them installed.

```{r, message = FALSE, warning = FALSE}
library(disperser) # our package
library(ncdf4)
library(data.table)
library(tidyverse)
library(kableExtra)
library(parallel)
library(sf)
library(viridis)
library(ggplot2)
library(scales)
library(maps)
library(ggsn)
```

The `create_dirs` function creates a project folder with all the necessary subfolders that we need. Begin by setting up your project with this function. Provide the path to where you would like your project to live in the `location` argument. By default, this function will create a main directory on your desktop. It will also assign paths to string variables in your environment. 

The set up is the following:

* `main`: The main folder where the project will be located. 
  + `input`: the input that we need for calculations. 
    * `zcta_500k`: ZCTA (A Zip Code Tabulation Area) shapefiles
    * `hpbl`: Monthly global planetary boundary layer files.
    * `meteo`: (reanalysis) meteorology files
  + `output`
    * `hysplit`: hyspdisp output (one file for each emissions event)
    * `ziplink`: files containing ZIP code linkages
    * `rdata`: RData files containing HyADS source-receptor matrices
    * `exp`: exposure per zipcode data 
  + `process`: temporary files that are created when the model is running and then deleted


```{r}
create_dirs()
```

## The inputs 

The next step is to get the data necessary for the analysis.  Let's start by loading data sets that are provided inside `disperser`.

### The crosswalk

ZIP code linkage procedure requires a ZCTA-to-ZIP code crosswalk file. ZCTAs are not exact geographic matches to ZIP codes, and multiple groups compile and maintain Crosswalk files. We used the Crosswalk mainted by UDS Mapper and preprocessed it also including information about the population size. While not necessary for the HYSPLIT model or processing of its outputs, population-weighted exposure metrics allow for direct comparisons between power plants. If you would like to know more details about how this crosswalk was prepared, we have attached a vignette that explains it. 

Let's load the crosswalk file. 

```{r}
crosswalk <- disperser::crosswalk
```

The disper package also includes monthly power plant emissions, load, and heat input data, accessible using the following command:

### The monthly powerplant emissions
```{r}
PP.units.monthly1995_2017 <- disperser::PP.units.monthly1995_2017
```


